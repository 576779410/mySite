<!DOCTYPE html>
<html lang="en">

<head>
    <title>基于BIM的大型展厅引导系统</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }

        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
        }

        #info a {
            color: #f00;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer
        }
    </style>
</head>

<body>
<div id="info">
    感谢湖工土建学院提供大型展厅的BIM模型！</br>
    指导老师：靳华中
</div>

<script src="three.js"></script>
<script src="flyControl.js"></script>
<script src="polylineGeometry.js"></script>

<script>
    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 20000000);
    var renderer = new THREE.WebGLRenderer();

    var flyControl = FlyControl(camera, scene, renderer)
    flyControl.add()
    init()

    function render() {
        renderer.render(scene, camera);
    }

    function init() {
        var container = document.createElement('div');
        container.appendChild(renderer.domElement);
        document.body.appendChild(container);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        camera.position.y = 60000;
        var center = new THREE.Vector3(0, 0, 0)
        camera.lookAt(center)

        var objectLoader = new THREE.ObjectLoader();
        objectLoader.load("zt.rvt.json", function (obj) {

            var c = obj.children
            for (var i = 0; i < c.length; i++) {
                scene.children[i] = obj.children[i]
            }
            var ambient = new THREE.AmbientLight(0x444444);
            scene.add(ambient);
            var directionalLight = new THREE.DirectionalLight(0xffeedd);
            directionalLight.position.set(0, 0, 1).normalize();
            scene.add(directionalLight);
            requestAnimationFrame(render)
        });

    }

    window.addEventListener('touchend', function () {
        var a = {x: 0, y: 0, z: -8000}
        var b = {x: -3600, y: 0, z: -4800}
        var c = {x: -3600, y: 0, z: 400}
        var d = {x: 3400, y: 0, z: 400}
        var e = {x: 3400, y: 0, z: 6400}
        var f = {x: 8000, y: 0, z: 6400}

        var polyline = [a, b, c, d, e, f]
        var pg = polylineGeometry(polyline, 300)
        scene.add(pg)

        requestAnimationFrame(render)

        function begin() {
            var xhr = new XMLHttpRequest()
            xhr.open('GET', 'getdata')
            xhr.onreadystatechange = function () {
                if (xhr.status === 200 && xhr.readyState === 4) {
                    var cj = xhr.responseText
                    cj = JSON.parse(cj)
                    //console.log(cj)


                    var i = 0

                    function hi() {
                        requestAnimationFrame(hi)
                        alibb()
                    }

                    hi()

                    function alibb() {
                        console.log('gogogog')
                        camera.matrix.elements[0] = cj[i][0]
                        camera.matrix.elements[1] = cj[i][1]
                        camera.matrix.elements[2] = cj[i][2]
                        camera.matrix.elements[3] = cj[i][3]

                        camera.matrix.elements[4] = cj[i][4]
                        camera.matrix.elements[5] = cj[i][5]
                        camera.matrix.elements[6] = cj[i][6]
                        camera.matrix.elements[7] = cj[i][7]

                        camera.matrix.elements[8] = cj[i][8]
                        camera.matrix.elements[9] = cj[i][9]
                        camera.matrix.elements[10] = cj[i][10]
                        camera.matrix.elements[11] = cj[i][11]

                        camera.matrix.elements[12] = cj[i][12]
                        camera.matrix.elements[13] = cj[i][13]
                        camera.matrix.elements[14] = cj[i][14]
                        camera.matrix.elements[15] = cj[i][15]

                        camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);
                        render()
                        i++
                    }


                }
            }
            xhr.send()
        }

        setTimeout(begin, 2000)
        init();
    })
    //camera.position.x = 0
    //camera.position.y = 0
    //camera.position.z = -8000

    /*
    var gogo = 0

    var befI = 0
    var nextI = 1

    function animation()
    {
        requestAnimationFrame(animation)
        var before = polyline[befI]
        var next = polyline[nextI]
        function lengthOf(a, b) {
            var c = subtract(a, b)
            return Math.sqrt(c.x * c.x + c.y * c.y + c.z * c.z)
        }

        render()
    }


})*/

    /* window.addEventListener('touchend', function () {
         var a = {x: 0, y: 0, z: -8000}
         var b = {x: -3600, y: 0, z: -4800}
         var c = {x: -3600, y: 0, z: 400}
         var d = {x: 3400, y: 0, z: 400}
         var e = {x: 3400, y: 0, z: 6400}
         var f = {x: 8000, y: 0, z: 6400}

         var polyline = [a, b, c, d, e, f]
         var pg = polylineGeometry(polyline, 300)
         scene.add(pg)

         requestAnimationFrame(render)

         function begin(){
             var xhr = new XMLHttpRequest()
             xhr.open('GET', 'getdata')
             xhr.onreadystatechange = function(){
                 if(xhr.status === 200 && xhr.readyState === 4)
                 {
                     var cj = xhr.responseText
                     cj = JSON.parse(cj)
                     //console.log(cj)




                     for(let i = 0; i < cj.length; i++)
                     {
                         setTimeout(alibb,10000)

                         function alibb() {
                             console.log('gogogog')
                             camera.matrix.elements[0] = cj[i][0]
                             camera.matrix.elements[1] = cj[i][1]
                             camera.matrix.elements[2] = cj[i][2]
                             camera.matrix.elements[3] = cj[i][3]

                             camera.matrix.elements[4] = cj[i][4]
                             camera.matrix.elements[5] = cj[i][5]
                             camera.matrix.elements[6] = cj[i][6]
                             camera.matrix.elements[7] = cj[i][7]

                             camera.matrix.elements[8] = cj[i][8]
                             camera.matrix.elements[9] = cj[i][9]
                             camera.matrix.elements[10] = cj[i][10]
                             camera.matrix.elements[11] = cj[i][11]

                             camera.matrix.elements[12] = cj[i][12]
                             camera.matrix.elements[13] = cj[i][13]
                             camera.matrix.elements[14] = cj[i][14]
                             camera.matrix.elements[15] = cj[i][15]

                             camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);
                             requestAnimationFrame(render)
                         }
                     }

                 }
             }
             xhr.send()
         }

         setTimeout(begin,2000)

         //camera.position.x = 0
         //camera.position.y = 0
         //camera.position.z = -8000

         /*
         var gogo = 0

         var befI = 0
         var nextI = 1

         function animation()
         {
             requestAnimationFrame(animation)
             var before = polyline[befI]
             var next = polyline[nextI]
             function lengthOf(a, b) {
                 var c = subtract(a, b)
                 return Math.sqrt(c.x * c.x + c.y * c.y + c.z * c.z)
             }

             render()
         }


     }) */

    /* window.addEventListener('click', function () {
        var a = {x: 0, y: 0, z: -8000}
        var b = {x: -3600, y: 0, z: -4800}
        var c = {x: -3600, y: 0, z: 400}
        var d = {x: 3400, y: 0, z: 400}
        var e = {x: 3400, y: 0, z: 6400}
        var f = {x: 8000, y: 0, z: 6400}

        var polyline = [a, b, c, d, e, f]
        var pg = polylineGeometry(polyline, 300)
        scene.add(pg)

        requestAnimationFrame(render)



    }) */


</script>

</body>

</html>